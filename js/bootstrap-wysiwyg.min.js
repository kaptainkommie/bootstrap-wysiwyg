/* @fileoverview 
 * Provides full Bootstrap based, multi-instance WYSIWYG editor.
 *
 * Name     = bootstrap-wysiwyg
 * Author   = Various, see LICENCE
 * Version  = v2.0.1
 * About    = A tiny Bootstrap and jQuery based WYSIWYG rich text editor based on the browser function execCommand.
*/

!function(e,t){"use strict";function n(n,o){this.selectedRange=null,this.editor=t(n);var a=t(n),i={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,enableImageSizeRestrictions:!0,imageMaxWidth:300,imageMaxHeight:300,fileUploadError:function(e,t){console.log("File upload error",e,t)}},r=t.extend(!0,{},i,o),l="a[data-"+r.commandRole+"],button[data-"+r.commandRole+"],input[type=button][data-"+r.commandRole+"]";this.bindHotkeys(a,r,l),r.dragAndDropImages&&this.initFileDrops(a,r,l),this.bindToolbar(a,t(r.toolbarSelector),r,l),a.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){this.saveSelection(),this.updateToolbar(a,l,r)}.bind(this)),t(e).bind("touchend",function(e){var t=a.is(e.target)||a.has(e.target).length>0,n=this.getCurrentRange();n&&n.startContainer===n.endContainer&&n.startOffset===n.endOffset&&!t||(this.saveSelection(),this.updateToolbar(a,l,r))})}n.prototype.readFileIntoDataUrl=function(e){var n=t.Deferred(),o=new FileReader;return o.onload=function(e){n.resolve(e.target.result)},o.onerror=n.reject,o.onprogress=n.notify,o.readAsDataURL(e),n.promise()},n.prototype.cleanHtml=function(e){var n=this;if(!0===t(n).data("wysiwyg-html-mode")&&(t(n).html(t(n).text()),t(n).attr("contenteditable",!0),t(n).data("wysiwyg-html-mode",!1)),!0===e&&t(n).parent().is("form")){var o=t(n).html;if(t(o).has("img").length){var a=t("img",t(o)),i=[],r=t(n).parent();t.each(a,function(e,n){t(n).attr("src").match(/^data:image\/.*$/)&&(i.push(a[e]),t(r).prepend("<input value='"+t(n).attr("src")+"' type='hidden' name='postedimage/"+e+"' />"),t(n).attr("src","postedimage/"+e))})}}var l=t(n).html();return l&&l.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},n.prototype.updateToolbar=function(e,n,o){o.activeToolbarClass&&t(o.toolbarSelector).find(n).each(function(){var e=t(this),n=e.data(o.commandRole).split(" "),a=n[0];n.length>1&&document.queryCommandSupported(a)&&document.queryCommandEnabled(a)&&document.queryCommandValue(a)===n[1]?e.addClass(o.activeToolbarClass):1===n.length&&document.queryCommandSupported(a)&&document.queryCommandEnabled(a)&&document.queryCommandState(a)?e.addClass(o.activeToolbarClass):e.removeClass(o.activeToolbarClass)})},n.prototype.execCommand=function(e,t,n,o,a){var i=e.split(" "),r=i.shift(),l=i.join(" ")+(t||""),s=e.split("-");1===s.length&&document.queryCommandSupported(r)?document.execCommand(r,!1,l):"format"===s[0]&&2===s.length?document.execCommand("formatBlock",!1,s[1]):1===s.length&&"insertHTML"===r&&this.insertHTML(l,n),n.trigger("change"),this.updateToolbar(n,a,o)},n.prototype.bindHotkeys=function(e,n,o){var a=this;t.each(n.hotKeys,function(i,r){r&&t(e).keydown(i,function(i){e.attr("contenteditable")&&t(e).is(":visible")&&(i.preventDefault(),i.stopPropagation(),a.execCommand(r,null,e,n,o))}).keyup(i,function(n){e.attr("contenteditable")&&t(e).is(":visible")&&(n.preventDefault(),n.stopPropagation())})}),e.keyup(function(){e.trigger("change")})},n.prototype.getCurrentRange=function(){var t,n;return e.getSelection?(t=e.getSelection()).getRangeAt&&t.rangeCount&&(n=t.getRangeAt(0)):document.selection&&(n=document.selection.createRange()),n},n.prototype.saveSelection=function(){this.selectedRange=this.getCurrentRange()},n.prototype.restoreSelection=function(){var t;if(e.getSelection||document.createRange){if(t=e.getSelection(),this.selectedRange){try{t.removeAllRanges()}catch(e){document.body.createTextRange().select(),document.selection.empty()}t.addRange(this.selectedRange)}}else document.selection&&this.selectedRange&&this.selectedRange.select()},n.prototype.toggleHtmlEdit=function(e){if(!0!==e.data("wysiwyg-html-mode")){var n=e.html(),o=t("<pre />");t(o).append(document.createTextNode(n)),t(o).attr("contenteditable",!0),t(e).html(" "),t(e).append(t(o)),t(e).attr("contenteditable",!1),t(e).data("wysiwyg-html-mode",!0),t(o).focus()}else t(e).html(t(e).text()),t(e).attr("contenteditable",!0),t(e).data("wysiwyg-html-mode",!1),t(e).focus()},n.prototype.insertFontSize=function(e,t,n,o,a){var i=this;n.focus(),i.execCommand("fontSize 7",null,n,o,a),n.find('font[size="7"]').removeAttr("size").css("font-size",e+("pt"===t?"pt":"px"))},n.prototype.insertHTML=function(e,t){t.focus();var n=document.createElement("div");n.innerHTML=e;for(var o,a=document.createDocumentFragment();o=n.firstChild;)a.appendChild(o);this.selectedRange.insertNode(a)},n.prototype.resizeImageOnce=function(e,t,n){if(e){var o=performance.now(),a=document.createElement("canvas"),i=a.getContext("2d");a.width=t,a.height=n,i.drawImage(e,0,0,a.width,a.height);var r=performance.now();return console.log("Call to resizeImageOnce took "+(r-o)+" milliseconds."),a.toDataURL()}return null},n.prototype.resizeImageStepped=function(e,t,n){if(e){var o=performance.now(),a=document.createElement("canvas"),i=a.getContext("2d"),r=document.createElement("canvas"),l=r.getContext("2d");r.width=t,r.height=n,a.width=.5*e.width,a.height=.5*e.height,i.drawImage(e,0,0,a.width,a.height),i.drawImage(a,0,0,.5*a.width,.5*a.height),l.drawImage(a,0,0,.5*a.width,.5*a.height,0,0,r.width,r.height);var s=performance.now();return console.log("Call to resizeImageStepped took "+(s-o)+" milliseconds."),r.toDataURL()}return null},n.prototype.calculateAspectRatioFit=function(e,t,n,o){var a=Math.min(n/e,o/t);return{width:e*a,height:t*a}},n.prototype.insertFiles=function(e,n,o,a){var i=this;o.focus(),t.each(e,function(e,r){/^image\//.test(r.type)?t.when(i.readFileIntoDataUrl(r)).done(function(e){if(n.enableImageSizeRestrictions){var t=new Image;t.onload=function(){if(n.imageMaxWidth>0&&t.width>n.imageMaxWidth||n.imageMaxHeight>0&&t.height>n.imageMaxHeight){var r=i.calculateAspectRatioFit(t.width,t.height,n.imageMaxWidth,n.imageMaxHeight),l=i.resizeImageOnce(t,r.width,r.height);l&&(e=l)}i.execCommand("insertimage",e,o,n,a),o.trigger("image-inserted")},t.src=e}else i.execCommand("insertimage",e,o,n,a),o.trigger("image-inserted")}).fail(function(e){n.fileUploadError("file-reader",e)}):n.fileUploadError("unsupported-file-type",r.type)})},n.prototype.markSelection=function(e,t){this.restoreSelection(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",!1,e||"transparent"),this.saveSelection()},n.prototype.bindToolbar=function(e,n,o,a){var i=this;n.find(a).click(function(){if(i.restoreSelection(),e.focus(),"html"===t(this).data(o.commandRole))i.toggleHtmlEdit(e);else if(t(this).data(o.commandRole).indexOf("fontPixel")>=0){(n=t(this).data(o.commandRole).split(" ")).shift();r=n.join(" ")+"";i.insertFontSize(r,"px",e,o,a)}else if(t(this).data(o.commandRole).indexOf("fontPoint")>=0){var n=t(this).data(o.commandRole).split(" ");n.shift();var r=n.join(" ")+"";i.insertFontSize(r,"pt",e,o,a)}else i.execCommand(t(this).data(o.commandRole),null,e,o,a);i.saveSelection()}),n.find("[data-toggle=dropdown]").click(i.markSelection(o.selectionColor,o)),n.on("hide.bs.dropdown",i.markSelection(!1,o)),n.find("input[type=text][data-"+o.commandRole+"]").on("webkitspeechchange change",function(){var n=this.value;this.value="",i.restoreSelection(),n&&(e.focus(),i.execCommand(t(this).data(o.commandRole),n,e,o,a)),i.saveSelection()}).on("blur",function(){i.markSelection(!1,o)}),n.find("input[type=file][data-"+o.commandRole+"]").change(function(){i.restoreSelection(),"file"===this.type&&this.files&&this.files.length>0&&i.insertFiles(this.files,o,e,a),i.saveSelection(),this.value=""})},n.prototype.initFileDrops=function(e,t,n){var o=this;e.on("dragenter dragover",!1).on("drop",function(a){var i=a.originalEvent.dataTransfer;a.stopPropagation(),a.preventDefault(),i&&i.files&&i.files.length>0&&o.insertFiles(i.files,t,e,n)})},t.fn.wysiwyg=function(e){new n(this,e);return this},t.fn.cleanHtml=function(){return n.prototype.cleanHtml.apply(this)}}(window,window.jQuery);
